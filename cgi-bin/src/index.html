<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Linux manager</title>
		<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
		<style>
			.sorting-asc::after {
				content: " [/\\]";
			}
			
			.sorting-desc::after {
				content: " [v]";
			}
		</style>
		<script>
			class Searcher {
				constructor() {}

				logout() {
					return fetch('logout.sh');
				}
				
				getProcesses() {
					return fetch('processes.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getLogs() {
					return fetch('logs.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				killProcess(pid) {
					return fetch(`kill.sh?pid=${pid}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
			};
			
			const searcher = new Searcher();
			function logout() {
				searcher.logout().then((e)=>{
					document.cookie = 'token='; // remove token
					window.location = '/'; // ja s'ha fet logout, torna a la pàgina principal
				});
			}
			
			function show(el) {
				processes_app.setActive(false);
				logs_app.setActive(false);
				
				eval(`${el}_app`).setActive(true);
			}
		</script>
	</head>
	<body>
		<header>
			<nav>
				<a href="#" onclick="show('processes')">Gestió de procéssos</a>
				<a href="#" onclick="show('logs')">Gestió de logs</a>
				<a href="#" onclick="">Gestió de logs</a>
				<a href="#" onclick="">Gestió d'usuaris</a>
				<a href="#" onclick="">Filtrat de paquets</a>
			</nav>
			<a href="#" onclick="logout()">Logout</a>
		</header>
		<main>
			<section id="processes" v-if="active">
				<h1>Gestió de processos</h1>
				
				<div>Temps encès: <span>{{uptime}}</span></div>
				<div>CPU: <span>{{cpu_usage()}}</span></div>
				<div>RAM: <span>{{ram_usage}}</span></div>
				<div>Disc: <span>{{disc_usage}}</span></div>
				<div>Auto-reload <input type="checkbox" v-model="reload" @change="reloadChanged()" /></div>
				
				<table>
				  <tr>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'command' && !desc, 'sorting-desc': sort_by === 'command' && desc }" @click="setSort('command')">Nom</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'user' && !desc, 'sorting-desc': sort_by === 'user' && desc }" @click="setSort('user')">Usuari</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'pid' && !desc, 'sorting-desc': sort_by === 'pid' && desc }" @click="setSort('pid')">PID</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'cpu' && !desc, 'sorting-desc': sort_by === 'cpu' && desc }" @click="setSort('cpu')">CPU</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'mem' && !desc, 'sorting-desc': sort_by === 'mem' && desc }" @click="setSort('mem')">RAM</th>
					<th></th>
				  </tr>
				  <tr v-for="p in sortedProcesses">
					<td>{{p.command}}</td>
					<td>{{p.user}}</td>
					<td>{{p.pid}}</td>
					<td>{{Math.trunc(p.cpu*100)}}%</td>
					<td>{{Math.trunc(p.mem*100)}}%</td>
					<td><button @click="kill(p.pid)">x</button></td>
				  </tr>
				</table>
				
				<div v-bind:class="i.style" v-for="i in info">
					{{i.msg}}
					<button @click="discardError(i.id)">x</button>
				</div>
			</section>
			
			<section id="logs" v-if="active">
				<h1>Gestió de logs</h1>
				
				<article>
					<h3>Últims accessos</h3>
					<table>
					  <tr>
						<th>Usuari</th>
						<th>Data</th>
					  </tr>
					  <tr v-for="l in last">
						<td>{{l.user}}</td>
						<td>{{l.date}}</td>
					  </tr>
					</table>
				</article>
				
				<article>
					<h3>Logs</h3>
					<textarea readonly>{{logs}}</textarea>
				</article>
			</section>
		</main>
		
		<script>
			var processes_app = new Vue({
				el: '#processes',
				data: {
					active: true,
					reload: true,
					
					uptime: '',
					ram_usage: '',
					disc_usage: '',
					processes: [],
					sortedProcesses: [],
					
					info: [],
					
					/* sort variables */
					sort_by: 'user',
					desc: false
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
					},
					cpu_usage: function() {
						return `${Math.trunc(this.processes.reduce((acum,curr)=>acum+curr.cpu, 0)*100)}%`;
					},
					kill: function(pid) {
						searcher.killProcess(pid).then((e)=>{
							if (e.status === 200) this.appendInfo(e.result);
							else this.appendError(e.err);
						});
					},
					load: function() {
						searcher.getProcesses().then((r)=>{
							if (r.status === 200) {
								this.uptime = r.uptime;
								this.ram_usage = `${Math.trunc(r.ram_usage*100)}%`
								this.disc_usage = `${Math.trunc(r.disc_usage*100)}%`;
								this.processes = r.processes;
								this.reloadSortedProcesses();
								
								if (this.reload) setTimeout(this.load, 1500); // torna a cridar en 2s
							}
						});
					},
					reloadChanged: function() {
						if (this.reload) this.load();
					},
					reloadSortedProcesses: function() {
						this.sortedProcesses =
							this.processes.sort((a,b)=>{
								if (this.desc) {
									if (a[this.sort_by] > b[this.sort_by]) return -1;
									return a[this.sort_by] < b[this.sort_by];
								}
								else {
									if (a[this.sort_by] < b[this.sort_by]) return -1;
									return a[this.sort_by] > b[this.sort_by];
								}
							});
					},
					setSort: function(criteria) {
						if (this.sort_by == criteria) this.desc = !this.desc; // s'ha clickat el mateix, fer el toggle
						else this.sort_by = criteria;
						this.reloadSortedProcesses();
					},
					
					/* popup functions */
					appendVar(_msg, _style) {
						let id = 0;
						if (this.info.length > 0) id = this.info[this.info.length - 1].id + 1;
						
						this.info.push({id:id, msg:_msg, style:_style});
						
						setTimeout(()=>this.discardVar(id), 8000);
					},
					appendError: function(err) {
						this.appendVar(err, 'error');
					},
					appendInfo: function(msg) {
						this.appendVar(msg, 'info');
					},
					discardVar: function(error_id) {
						this.info = this.info.filter(e => e.id !== error_id);
					}
				},
				beforeMount() {
					this.load();
				}
			});
			
			var logs_app = new Vue({
				el: '#logs',
				data: {
					active: false,
					last: [],
					logs: ''
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
						if (bool) this.load();
					},
					load: function() {
						searcher.getLogs().then((r)=>{
							if (r.status === 200) {
								this.last = r.last;
								this.logs = r.logs;
							}
						});
					}
				},
				beforeMount() {
					this.load();
				}
			});
		</script>
	</body>
</html>