<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Linux manager</title>
		<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
		<style>
			.sorting-asc::after {
				content: " [/\\]";
			}
			
			.sorting-desc::after {
				content: " [v]";
			}
		</style>
		<script>
			class Searcher {
				constructor() {}

				logout() {
					return fetch('logout.sh');
				}
				
				getProcesses() {
					return fetch('processes.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getLogs() {
					return fetch('logs.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				killProcess(pid) {
					return fetch(`kill.sh?pid=${pid}`);
				}
				
				getHints(path) {
					return fetch(`search.sh?path=${path}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getTasks() {
					return fetch('cron.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				addTask(minute, hour, m_day, month, w_day, script) {
					return fetch(`cron.sh?action=add&minute=${minute}&hour=${hour}&m_day=${m_day}&month=${month}&w_day=${w_day}&script=${script.replaceAll('&', encodeURIComponent('&'))}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
			};
			
			const searcher = new Searcher();
			function logout() {
				searcher.logout().then((e)=>{
					document.cookie = 'token='; // remove token
					window.location = '/'; // ja s'ha fet logout, torna a la pàgina principal
				});
			}
			
			function show(el) {
				processes_app.setActive(false);
				logs_app.setActive(false);
				tasks_app.setActive(false);
				
				eval(`${el}_app`).setActive(true);
			}
		</script>
	</head>
	<body>
		<header>
			<nav>
				<a href="#" onclick="show('processes')">Gestió de procéssos</a>
				<a href="#" onclick="show('logs')">Gestió de logs</a>
				<a href="#" onclick="">Gestió de logs</a>
				<a href="#" onclick="">Gestió d'usuaris</a>
				<a href="#" onclick="">Filtrat de paquets</a>
				<a href="#" onclick="show('tasks')">Programació de tasques</a>
			</nav>
			<a href="#" onclick="logout()">Logout</a>
		</header>
		<main>
			<section id="processes" v-if="active">
				<h1>Gestió de processos</h1>
				
				<div>Temps encès: <span>{{uptime}}</span></div>
				<div>CPU: <span>{{cpu_usage()}}</span></div>
				<div>RAM: <span>{{ram_usage}}</span></div>
				<div>Disc: <span>{{disc_usage}}</span></div>
				<div>Auto-reload <input type="checkbox" v-model="reload" @change="reloadChanged()" /></div>
				
				<table>
				  <tr>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'command' && !desc, 'sorting-desc': sort_by === 'command' && desc }" @click="setSort('command')">Nom</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'user' && !desc, 'sorting-desc': sort_by === 'user' && desc }" @click="setSort('user')">Usuari</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'pid' && !desc, 'sorting-desc': sort_by === 'pid' && desc }" @click="setSort('pid')">PID</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'cpu' && !desc, 'sorting-desc': sort_by === 'cpu' && desc }" @click="setSort('cpu')">CPU</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'mem' && !desc, 'sorting-desc': sort_by === 'mem' && desc }" @click="setSort('mem')">RAM</th>
					<th></th>
				  </tr>
				  <tr v-for="p in sortedProcesses">
					<td>{{p.command}}</td>
					<td>{{p.user}}</td>
					<td>{{p.pid}}</td>
					<td>{{Math.trunc(p.cpu*100)}}%</td>
					<td>{{Math.trunc(p.mem*100)}}%</td>
					<td><button @click="kill(p.pid)">x</button></td>
				  </tr>
				</table>
			</section>
			
			<section id="logs" v-if="active">
				<h1>Gestió de logs</h1>
				
				<article>
					<h3>Últims accessos</h3>
					<table>
					  <tr>
						<th>Usuari</th>
						<th>Data</th>
					  </tr>
					  <tr v-for="l in last">
						<td>{{l.user}}</td>
						<td>{{l.date}}</td>
					  </tr>
					</table>
				</article>
				
				<article>
					<h3>Logs</h3>
					<textarea readonly>{{logs}}</textarea>
				</article>
			</section>
			
			<section id="tasks" v-if="active">
				<h1>Programació de tasques</h1>
				
				<table>
				  <tr>
					<th>Usuari</th>
					<th>Minut</th>
					<th>Hora</th>
					<th>Dia del mes</th>
					<th>Mes</th>
					<th>Dia de la setmana</th>
					<th>Script</th>
					<th></th>
				  </tr>
				  <tr v-for="task in tasks">
					<td>{{task.user}}</td>
					<td>{{task.minute}}</td>
					<td>{{task.hour}}</td>
					<td>{{task.m_day}}</td>
					<td>{{task.month}}</td>
					<td>{{task.w_day}}</td>
					<td>{{task.script}}</td>
					<td><button @click="remove(task)">x</button></td>
				  </tr>
				</table>
				
				<article>
					<h3>Crear</h3>
					<form class="shadow" action="cron_post.sh" onsubmit="return false;"> <!-- method="post" enctype="application/x-www-form-urlencoded" -->
						<label for="script">Script</label>
						<input type="text" ref="script" id="script" v-model="script_path" @keypress="pathChanging()" list="files" required />
						<datalist id="files">
							<option v-for="f in paths" v-bind:value="f.path" />
						</datalist>
						
						<label for="minute">Minut</label>
						<input type="text" id="minute" v-model="script_minute" required />
						<label for="hour">Hora</label>
						<input type="text" id="hour" v-model="script_hour" required />
						<label for="m_day">Dia del mes</label>
						<input type="text" id="m_day" v-model="script_m_day" required />
						<label for="month">Mes</label>
						<input type="text" id="month" v-model="script_month" required />
						<label for="w_day">Dia de la setmana</label>
						<input type="text" id="w_day" v-model="script_w_day" required />
						
						<button @click="add()">+</button>
					</form>
				</article>
			</section>
		</main>
		
		<script>
			var processes_app = new Vue({
				el: '#processes',
				data: {
					active: true,
					reload: true,
					
					uptime: '',
					ram_usage: '',
					disc_usage: '',
					processes: [],
					sortedProcesses: [],
					
					/* sort variables */
					sort_by: 'user',
					desc: false
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
						if (bool) this.load();
					},
					cpu_usage: function() {
						return `${Math.trunc(this.processes.reduce((acum,curr)=>acum+curr.cpu, 0)*100)}%`;
					},
					kill: function(pid) {
						searcher.killProcess(pid).then((e)=>console.log(e.result));
					},
					load: function() {
						searcher.getProcesses().then((r)=>{
							if (r.status === 200) {
								this.uptime = r.uptime;
								this.ram_usage = `${Math.trunc(r.ram_usage*100)}%`
								this.disc_usage = `${Math.trunc(r.disc_usage*100)}%`;
								this.processes = r.processes;
								this.reloadSortedProcesses();
								
								if (this.reload && this.active) setTimeout(this.load, 1500); // torna a cridar en 2s
							}
						});
					},
					reloadChanged: function() {
						if (this.reload) this.load();
					},
					reloadSortedProcesses: function() {
						this.sortedProcesses =
							this.processes.sort((a,b)=>{
								if (this.desc) {
									if (a[this.sort_by] > b[this.sort_by]) return -1;
									return a[this.sort_by] < b[this.sort_by];
								}
								else {
									if (a[this.sort_by] < b[this.sort_by]) return -1;
									return a[this.sort_by] > b[this.sort_by];
								}
							});
					},
					setSort: function(criteria) {
						if (this.sort_by == criteria) this.desc = !this.desc; // s'ha clickat el mateix, fer el toggle
						else this.sort_by = criteria;
						this.reloadSortedProcesses();
					}
				},
				beforeMount() {
					this.load();
				}
			});
			
			var logs_app = new Vue({
				el: '#logs',
				data: {
					active: false,
					last: [],
					logs: ''
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
						if (bool) this.load();
					},
					load: function() {
						searcher.getLogs().then((r)=>{
							if (r.status === 200) {
								this.last = r.last;
								this.logs = r.logs;
							}
						});
					}
				},
				beforeMount() {
					this.load();
				}
			});
			
			var tasks_app = new Vue({
				el: '#tasks',
				data: {
					active: false,
					
					script_path: '',
					script_minute: '',
					script_hour: '',
					script_m_day: '',
					script_month: '',
					script_w_day: '',
					
					paths: [],
					tasks: []
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
					},
					add: function() {
						searcher.addTask(this.script_minute, this.script_hour, this.script_m_day, this.script_month, this.script_w_day, this.script_path).then((r)=>{
								if (r.status === 200) this.load();
							});
					},
					pathChanging: function() {
						setTimeout(this.pathChanged, 1); // keypress encara no ha afegit la tecla a la variable
					},
					pathChanged: function() {
						searcher.getHints(this.script_path).then((e)=>{
							this.paths = e.results;
							if (this.$refs.script !== undefined) this.$refs.script.focus(); // si no datalist no es recarga
						});
					},
					remove: function(task) {
					
					},
					load: function() {
						searcher.getTasks().then((e)=>this.tasks = e.tasks);
					}
				},
				beforeMount() {
					this.pathChanged();
					this.load();
				}
			});
		</script>
	</body>
</html>