<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Linux manager</title>
		<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
		<style>
			/* general CSS */
			* {
				font-family:'Lucida Sans', 'Lucida Sans Regular', 'Lucida Grande', 'Lucida Sans Unicode', Geneva, Verdana, sans-serif;
				--header-width: 300px;
			}
			.shadow , .error , .info , #tasks table {
				box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.329);
			}
			body {
				margin: 0px;
			}
			header {
				display: flex;
				flex-direction: column;
				justify-content: space-between;
	
				background-color: #B8E1FF;
				position: absolute;
				top: 0px;
				left: 0px;
				height: calc(100%);
				width: var(--header-width);
			}
			main {
				position: absolute;
				top: 0px;
				left: 300px;
				padding: 40px 70px 70px 70px;
				width: calc(100% - 440px);
				height: calc(100% - 110px);
	
				display: flex;
				flex-direction: row;
			}
			
			.error , .info {
				position: relative;
				   width: 65%;
				display: flex;
				justify-content: center;
				align-items: center;
				padding: 25px;
				font-weight: 500;
				margin: 8px 8px 8px 17%;
				z-index: 10;
				opacity: 0.8;
				transition: opacity 0.2s;
			}
			.error:hover , .info:hover {
				opacity: 1;
			}
			.error > button , .info > button {
				position: absolute;
				   top: 2px;
				   right: 2px;
				background-color: transparent;
				border: none;
				z-index: 100;
			}
			.error {
				background-color: rgb(230, 89, 89);
			}
			
			.info {
				background-color: rgb(95, 175, 95);
			}
	
			header > nav {
				display: flex;
				flex-direction: column;
				align-items: flex-start;
				justify-content: flex-start;
			}
			header a {
				text-decoration: none;
				color: black;
				text-shadow: 0px 3px 5px rgba(0, 0, 0, 0.329);
				font-size: large;
				font-weight: 600;
			}
			header > nav > a {
				width: 76%;
				padding: 10% 12% 10% 12%;
			}
			header > div > a {
				padding: 10% 0px 10% 12%;
			}
			.selected {
				background-color: #20567c;
				color: white;
				box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.705);
			}
	
			h1 {
				margin-bottom: 35px;
				font-size: xx-large;
			}
			h3 {
				margin-top: 35px;
				font-size: large;
			}
			table {
				border-spacing: 0px 0px;
			}
	
			td , th {
				padding: 6px 30px 6px 30px;
			}
			tr:nth-child(2n) {
				background: #F8F8F8;
			}
			tr:nth-child(2n - 1) {
				background: #F1F1F1;
			}
			#start {
				width: 40px;
				height: 40px;
				margin-left: 25px;
			}
			#restart {
				width: 48px;
				height: 48px;
				margin-left: 25px;
			}
			header > div {
				display: flex;
				align-items: center;
			}
			.pointer:hover , button:hover {
				cursor: pointer;
			}
			button[disabled] {
				cursor: not-allowed;
			}
	
			.horizontal {
				display: flex;
				flex-direction: row;
				justify-content: space-between;
			}
			table button {
				background-color: red;
				transition: background-color 0.3s;
				color: white;
				font-weight: bolder;
				font-size: large;
				border: none;
				border-radius: 100px;
				box-shadow: 0px 3px 5px rgba(0, 0, 0, 0.329);
				width: 28px;
				height: 28px;
			}
			table button[disabled] {
				background-color: gray;
			}
	
			#tableProcess , #tasks table {
				overflow-y: scroll;
				table-layout: fixed;
				height: 70vh;
				display: block;
			}
			#processes, #tableProcess, #tableProcess tr:first-child > th {
				width: 100%;
			}
			#tableProcess tr:first-child , #tasks tr:first-child {
				position: sticky;
				top: 0;
				background-color: #84D3FF;
			}
	
			/* tasks CSS */
			#tasks table, #tasks table tr:first-child > th {
				width: 100%;
			}
			#tasks table {
				background-color: #F8F8F8;
				height: 80vh;
			}
			#tasks table tr:last-child > td:first-child {
				font-weight: bold;
			}
			#tasks table input {
            	width: 17vw;
			}
			#tasks table input:last-child {
				width: 2vw;
			}
			
			/* processes CSS */
			.sorting-asc::after {
				content: " [/\\]";
			}
			.sorting-desc::after {
				content: " [v]";
			}
			#statsHead {
				margin-bottom: 20px;
				width: 100%;
			}
			#statsHead > div:first-child {
				background-color: #C5EAFF;
				padding: 10px;
			}
			#statsHead > div:nth-child(2) {
				display: flex;
			}
			#statsHead > div > div {
				background-color: #84D3FF;
				padding: 10px;
				margin-left: 15px;
			}
			#statsHead div > span {
				font-weight: 1000;
			}
			
			/*#tableProcess tr:first-child > th {
				width: calc(70vh / 6);
			}*/
			#tableProcess tr > td {
				text-align: center;
			}
			#processes table button:hover {
				background-color: rgb(150, 26, 26);
			}
	
			/* logs CSS */
			textarea {
				width: 50vw;
				height: 33vh;
				font-size: medium;
				padding: 10px;
				border: none;
				background-color: #F1F1F1;
			}
			
			#logs > div {
				display: flex;
			}
			
			#logs > div > article:first-child {
				padding-right: 70px;
			}
		</style>
		<script>
			class Searcher {
				constructor() {}

				logout() {
					return fetch('logout.sh');
				}
				
				getProcesses() {
					return fetch('processes.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getLogs() {
					return fetch('logs.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				killProcess(pid) {
					return fetch(`kill.sh?pid=${pid}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getHints(path) {
					return fetch(`search.sh?path=${path}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getTasks() {
					return fetch('cron.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				addTask(minute, hour, m_day, month, w_day, script) {
					return fetch(`cron.sh?action=add&minute=${minute}&hour=${hour}&m_day=${m_day}&month=${month}&w_day=${w_day}&script=${encodeURIComponent(script)}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				removeTask(minute, hour, m_day, month, w_day, script, user) {
					return fetch(`cron.sh?action=remove&minute=${minute}&hour=${hour}&m_day=${m_day}&month=${month}&w_day=${w_day}&script=${encodeURIComponent(script)}&user=${user}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				getFilters() {
					return fetch('packets.sh').then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				addFilter(clase, ip_src, ip_dst, port_src, port_dst, protocol, action) {
					return fetch(`packets.sh?do=A&class=${clase}&action=${action}&ip_src=${ip_src}&ip_dst=${ip_dst}&port_src=${port_src}&port_dst=${port_dst}&protocol=${protocol}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
				
				removeFilter(clase, ip_src, ip_dst, port_src, port_dst, protocol, action) {
					return fetch(`packets.sh?do=D&class=${clase}&action=${action}&ip_src=${ip_src}&ip_dst=${ip_dst}&port_src=${port_src}&port_dst=${port_dst}&protocol=${protocol}`).then(response => {
								return response.json().then(e => {
									return {...e, status: response.status}
								});
							});
				}
			};
			
			const searcher = new Searcher();
			function logout() {
				searcher.logout().then((e)=>{
					document.cookie = 'token='; // remove token
					window.location = '/'; // ja s'ha fet logout, torna a la pàgina principal
				});
			}
			
			function validateCron(e) {
				var regex = /^[0-9/\-,*]+$/;
				var str = String.fromCharCode(!e.charCode ? e.which : e.charCode);
				if (regex.test(str)) return true;

				e.preventDefault();
				return false;
			}
		</script>
	</head>
	<body>
		<header>
			<nav>
				<a href="#" class="selected" id="processes_a" onmouseover="show('processes')">Gestió de procéssos</a>
				<a href="#" id="logs_a" onmouseover="show('logs')">Gestió de logs</a>
				<a href="#" onclick="">Gestió d'usuaris</a>
				<a href="#" id="paquets_a" onmouseover="show('paquets')">Filtrat de paquets</a>
				<a href="#" id="tasks_a" onmouseover="show('tasks')">Programació de tasques</a>
				<a href="#" id="music_a" onmouseover="show('music')">Music</a>
			</nav>
			
			<div>
				<a id="logout" href="#" onclick="logout()">Logout</a>
				<svg id="start" class="pointer" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 30.143 30.143" style="enable-background:new 0 0 30.143 30.143;" xml:space="preserve">
					<g>
						<path style="fill:#030104;" d="M20.034,2.357v3.824c3.482,1.798,5.869,5.427,5.869,9.619c0,5.98-4.848,10.83-10.828,10.83   c-5.982,0-10.832-4.85-10.832-10.83c0-3.844,2.012-7.215,5.029-9.136V2.689C4.245,4.918,0.731,9.945,0.731,15.801   c0,7.921,6.42,14.342,14.34,14.342c7.924,0,14.342-6.421,14.342-14.342C29.412,9.624,25.501,4.379,20.034,2.357z"/>
						<path style="fill:#030104;" d="M14.795,17.652c1.576,0,1.736-0.931,1.736-2.076V2.08c0-1.148-0.16-2.08-1.736-2.08   c-1.57,0-1.732,0.932-1.732,2.08v13.496C13.062,16.722,13.225,17.652,14.795,17.652z"/>
					</g>
				</svg>
				<svg id="restart" class="pointer" xmlns="http://www.w3.org/2000/svg" width="16px" height="16px" viewBox="0 0 16 16" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.75 8a4.5 4.5 0 0 1-8.61 1.834l-1.391.565A6.001 6.001 0 0 0 14.25 8 6 6 0 0 0 3.5 4.334V2.5H2v4l.75.75h3.5v-1.5H4.352A4.5 4.5 0 0 1 12.75 8z"/></svg>
			</div>
		</header>
		<main>
			<section id="processes" v-if="active">
				<h1>Gestió de processos</h1>
				<div id="statsHead" class="horizontal">
					<div>Temps encès: <span>{{uptime}}</span></div>
					<div>
						<div>CPU: <span>{{cpu_usage()}}</span></div>
						<div>RAM: <span>{{ram_usage}}</span></div>
						<div>Disc: <span>{{disc_usage}}</span></div>
						<div>Auto-reload <input type="checkbox" v-model="reload" @change="reloadChanged()" /></div>
					</div>
				</div>
				
				<table id="tableProcess">
				  <tr>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'command' && !desc, 'sorting-desc': sort_by === 'command' && desc }" @click="setSort('command')">Nom</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'user' && !desc, 'sorting-desc': sort_by === 'user' && desc }" @click="setSort('user')">Usuari</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'pid' && !desc, 'sorting-desc': sort_by === 'pid' && desc }" @click="setSort('pid')">PID</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'cpu' && !desc, 'sorting-desc': sort_by === 'cpu' && desc }" @click="setSort('cpu')">CPU</th>
					<th v-bind:class="{ 'sorting-asc': sort_by === 'mem' && !desc, 'sorting-desc': sort_by === 'mem' && desc }" @click="setSort('mem')">RAM</th>
					<th></th>
				  </tr>
				  <tr v-for="p in sortedProcesses">
					<td>{{p.command}}</td>
					<td>{{p.user}}</td>
					<td>{{p.pid}}</td>
					<td>{{Math.trunc(p.cpu*100)}}%</td>
					<td>{{Math.trunc(p.mem*100)}}%</td>
					<td><button @click="kill(p.pid)">x</button></td>
				  </tr>
				</table>
				
				<div v-bind:class="i.style" v-for="i in info">
					{{i.msg}}
					<button @click="discardVar(i.id)">x</button>
				</div>
			</section>
			
			<section id="logs" v-if="active">
				<h1>Gestió de logs</h1>
				
				<div>
					<article>
						<h3>Últims accessos</h3>
						<table>
						  <tr>
							<th>Usuari</th>
							<th>Data</th>
						  </tr>
						  <tr v-for="l in last">
							<td>{{l.user}}</td>
							<td>{{l.date}}</td>
						  </tr>
						</table>
					</article>
					
					<article>
						<h3>Logs</h3>
						<textarea readonly ref="logs_text">{{logs}}</textarea>
					</article>
				</div>
			</section>
			
			<section id="tasks" v-if="active">
				<h1>Programació de tasques</h1>
				
				<table>
				  <tr>
					<th>Usuari</th>
					<th>Minut</th>
					<th>Hora</th>
					<th>Dia del mes</th>
					<th>Mes</th>
					<th>Dia de la setmana</th>
					<th>Script</th>
					<th></th>
				  </tr>
				  <tr v-for="task in tasks">
					<td>{{task.user}}</td>
					<td>{{task.minute}}</td>
					<td>{{task.hour}}</td>
					<td>{{task.m_day}}</td>
					<td>{{task.month}}</td>
					<td>{{task.w_day}}</td>
					<td>{{task.script}}</td>
					<td><button @click="remove(task)">x</button></td>
				  </tr>
				  <tr>
					<td>Crear</td>
					<td><input type="text" v-model="script_minute" onkeypress="validateCron(event)" /></td>
					<td><input type="text" v-model="script_hour" onkeypress="validateCron(event)" /></td>
					<td><input type="text" v-model="script_m_day" onkeypress="validateCron(event)" /></td>
					<td><input type="text" v-model="script_month" onkeypress="validateCron(event)" /></td>
					<td><input type="text" v-model="script_w_day" onkeypress="validateCron(event)" /></td>
					<td>
						<input type="text" ref="script" v-model="script_path" @keypress="pathChanging()" list="files" />
						<datalist id="files">
							<option v-for="f in paths" v-bind:value="f.path" />
						</datalist>
					</td>
					<td><button @click="add()" :disabled='script_minute === "" || script_hour === "" || script_m_day === "" || script_month === "" || script_w_day === "" || script_path === ""'>+</button></td>
				  </tr>
				</table>
			</section>
			
			<section id="paquets" v-if="active">
				<h1>Filtrat de paquets</h1>
				
				<table>
				  <tr>
					<th>Class</th>
					<th>IP origen</th>
					<th>IP destí</th>
					<th>Port origen</th>
					<th>Port destí</th>
					<th>Protocol</th>
					<th>Action</th>
					<th></th>
				  </tr>
				  <template v-for="paquetss in paquets">
					  <tr v-for="packet in paquetss.filters">
						<td>{{paquetss.class}}</td>
						<td>{{packet.ip_src}}</td>
						<td>{{packet.ip_dst}}</td>
						<td>{{packet.spt}}</td>
						<td>{{packet.dpt}}</td>
						<td>{{packet.protocol}}</td>
						<td v-bind:class="{ accept: packet.action === 'ACCEPT', drop: packet.action === 'DROP' }">{{packet.action}}</td>
						<td><button @click="remove(paquetss.class, packet)">x</button></td>
					  </tr>
				  </template>
				  <tr>
					<td>
						<select v-model="filter_class">
							<option value="INPUT">INPUT</option>
							<option value="FORWARD">FORWARD</option>
							<option value="OUTPUT">OUTPUT</option>
						</select>
					</td>
					<td><input type="text" v-model="filter_ip_src" /></td>
					<td><input type="text" v-model="filter_ip_dst" /></td>
					<td><input type="text" v-if="filter_protocol === 'tcp' || filter_protocol === 'udp'" v-model="filter_port_src" /></td>
					<td><input type="text" v-if="filter_protocol === 'tcp' || filter_protocol === 'udp'" v-model="filter_port_dst" /></td>
					<td>
						<select v-model="filter_protocol">
							<option value="tcp">tcp</option>
							<option value="udp">udp</option>
							<option value="icmp">icmp</option>
							<option value="all">all</option>
						</select>
					</td>
					<td>
						<select v-model="filter_action">
							<option value="ACCEPT">ACCEPT</option>
							<option value="DROP">DROP</option>
						</select>
					</td>
					<td><button @click="add()">+</button></td>
				  </tr>
				</table>
			</section>
			
			<section id="music" v-if="active">
				<h1>Música</h1>
			</section>
		</main>
		
		<script>
			let processes_a = document.getElementById('processes_a'),
				tasks_a = document.getElementById('tasks_a');
				logs_a = document.getElementById('logs_a'),
				paquets_a = document.getElementById('paquets_a'),
				music_a = document.getElementById('music_a');
			function show(el) {
				processes_app.setActive(false);
				tasks_app.setActive(false);
				logs_app.setActive(false);
				paquets_app.setActive(false);
				music_app.setActive(false);
				processes_a.className = '';
				tasks_a.className = '';
				logs_a.className = '';
				paquets_a.className = '';
				music_a.className = '';
				
				eval(`${el}_app`).setActive(true);
				eval(`${el}_a`).className = 'selected';
			}
			
			var processes_app = new Vue({
				el: '#processes',
				data: {
					active: true,
					reload: true,
					
					uptime: '',
					ram_usage: '',
					disc_usage: '',
					processes: [],
					sortedProcesses: [],
					
					info: [],
					
					/* sort variables */
					sort_by: 'user',
					desc: false
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
						if (bool) this.load();
					},
					cpu_usage: function() {
						return `${Math.trunc(this.processes.reduce((acum,curr)=>acum+curr.cpu, 0)*100)}%`;
					},
					kill: function(pid) {
						searcher.killProcess(pid).then((e)=>{
							if (e.status === 200) this.appendInfo(e.result);
							else this.appendError(e.err);
						});
					},
					load: function() {
						searcher.getProcesses().then((r)=>{
							if (r.status === 200) {
								this.uptime = r.uptime;
								this.ram_usage = `${Math.trunc(r.ram_usage*100)}%`
								this.disc_usage = `${Math.trunc(r.disc_usage*100)}%`;
								this.processes = r.processes;
								this.reloadSortedProcesses();
								
								if (this.reload && this.active) setTimeout(this.load, 1500); // torna a cridar en 2s
							}
						});
					},
					reloadChanged: function() {
						if (this.reload) this.load();
					},
					reloadSortedProcesses: function() {
						this.sortedProcesses =
							this.processes.sort((a,b)=>{
								if (this.desc) {
									if (a[this.sort_by] > b[this.sort_by]) return -1;
									return a[this.sort_by] < b[this.sort_by];
								}
								else {
									if (a[this.sort_by] < b[this.sort_by]) return -1;
									return a[this.sort_by] > b[this.sort_by];
								}
							});
					},
					setSort: function(criteria) {
						if (this.sort_by == criteria) this.desc = !this.desc; // s'ha clickat el mateix, fer el toggle
						else this.sort_by = criteria;
						this.reloadSortedProcesses();
					},
					
					/* popup functions */
					appendVar(_msg, _style) {
						let id = 0;
						if (this.info.length > 0) id = this.info[this.info.length - 1].id + 1;
						
						this.info.push({id:id, msg:_msg, style:_style});
						
						setTimeout(()=>this.discardVar(id), 8000);
					},
					appendError: function(err) {
						this.appendVar(err, 'error');
					},
					appendInfo: function(msg) {
						this.appendVar(msg, 'info');
					},
					discardVar: function(id) {
						this.info = this.info.filter(e => e.id !== id);
					}
				},
				beforeMount() {
					this.load();
				}
			});
			
			var logs_app = new Vue({
				el: '#logs',
				data: {
					active: false,
					last: [],
					logs: ''
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
						if (bool) this.load();
					},
					setLogs: function(txt) {
						this.logs = txt;
						if (this.$refs.logs_text !== undefined) this.$refs.logs_text.scrollTop = this.$refs.logs_text.scrollHeight;
					},
					load: function() {
						searcher.getLogs().then((r)=>{
							if (r.status === 200) {
								this.last = r.last;
								this.setLogs(r.logs);
							}
						});
					}
				},
				beforeMount() {
					this.load();
				}
			});
			
			var tasks_app = new Vue({
				el: '#tasks',
				data: {
					active: false,
					
					script_path: '',
					script_minute: '',
					script_hour: '',
					script_m_day: '',
					script_month: '',
					script_w_day: '',
					
					paths: [],
					tasks: []
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
					},
					add: function() {
						searcher.addTask(this.script_minute, this.script_hour, this.script_m_day, this.script_month, this.script_w_day, this.script_path).then((r)=>{
								if (r.status === 200) {
									this.load();
									
									// reset
									this.script_path = '';
									this.script_minute = '';
									this.script_hour = '';
									this.script_m_day = '';
									this.script_month = '';
									this.script_w_day = '';
								}
							});
					},
					remove: function(task) {
						searcher.removeTask(task.minute, task.hour, task.m_day, task.month, task.w_day, task.script, task.user).then((r)=>{
								if (r.status === 200) this.load();
							});
					},
					pathChanging: function() {
						setTimeout(this.pathChanged, 1); // keypress encara no ha afegit la tecla a la variable
					},
					pathChanged: function() {
						searcher.getHints(this.script_path).then((e)=>{
							this.paths = e.results;
							if (this.$refs.script !== undefined) this.$refs.script.focus(); // si no datalist no es recarga
						});
					},
					load: function() {
						searcher.getTasks().then((e)=>this.tasks = e.tasks);
					}
				},
				beforeMount() {
					this.pathChanged();
					this.load();
				}
			});
			
			var music_app = new Vue({
				el: '#music',
				data: {
					active: false
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
					}
				},
				beforeMount() {
					
				}
			});
			
			var paquets_app = new Vue({
				el: '#paquets',
				data: {
					active: false,
					paquets: [],
					
					filter_class: 'INPUT',
					filter_ip_src: '',
					filter_ip_dst: '',
					filter_port_src: '',
					filter_port_dst: '',
					filter_protocol: 'tcp',
					filter_action: 'ACCEPT'
				},
				methods: {
					setActive: function(bool) {
						this.active = bool;
					},
					add: function() {
						searcher.addFilter(this.filter_class, this.filter_ip_src, this.filter_ip_dst, this.filter_port_src, this.filter_port_dst, this.filter_protocol, this.filter_action).then((e)=>this.load());
					},
					remove: function(clase, packet) {
						searcher.removeFilter(clase, packet.ip_src, packet.ip_dst, packet.spt === undefined ? '' : packet.spt, packet.dpt === undefined ? '' : packet.dpt, packet.protocol, packet.action).then((e)=>this.load());
					},
					load: function() {
						searcher.getFilters().then((r)=>this.paquets = r.filters);
					}
				},
				beforeMount() {
					this.load();
				}
			});
		</script>
	</body>
</html>